{% extends "base.html" %}

{% block content %}
<div class="calendar-page">
    <div class="container">
        <div class="calendar-header">
            <h1>Book Your Appointment</h1>
            <p class="calendar-subtitle">Select a date below to see available time slots</p>
        </div>

        <div class="calendar-container">
            <!-- Calendar Grid -->
            <div class="calendar-grid" id="calendar">
                <!-- Calendar will be generated by JavaScript -->
            </div>

            <!-- Time Slots Panel -->
            <div class="time-slots-panel" id="timeSlotsPanel" style="display: none;">
                <h3 id="selectedDateDisplay"></h3>
                <div class="time-slots-grid" id="timeSlots">
                    <!-- Time slots will appear here -->
                </div>
                <button class="btn btn-outline back-btn" onclick="backToCalendar()">
                    ← Back to Calendar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Calendar State
    let currentDate = new Date();
    let selectedDate = null;
    let blockedDates = []; // Will be populated from backend

    // Month names
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];

    // Day names (short)
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Initialize Calendar
    function initCalendar() {
        renderCalendar();
        fetchBlockedDates();
    }

    // Fetch blocked dates from backend
    function fetchBlockedDates() {
        fetch('/api/blocked-dates')
            .then(response => response.json())
            .then(data => {
                blockedDates = data.blocked_dates.map(date => new Date(date));
                renderCalendar(); // Re-render with blocked dates
            });
    }

    // Render Calendar
    function renderCalendar() {
        const calendar = document.getElementById('calendar');
        
        // Calendar Header
        let html = `
            <div class="calendar-header-controls">
                <button onclick="changeMonth(-1)" class="month-nav">←</button>
                <h2>${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}</h2>
                <button onclick="changeMonth(1)" class="month-nav">→</button>
            </div>
            <div class="weekdays">
                ${dayNames.map(day => `<div class="weekday">${day}</div>`).join('')}
            </div>
            <div class="days-grid">
        `;

        // First day of month
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const startingDay = firstDay.getDay();
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

        // Empty cells before first day
        for (let i = 0; i < startingDay; i++) {
            html += `<div class="calendar-day empty"></div>`;
        }

        // Calendar days
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // Check if date is blocked
            const isBlocked = isDateBlocked(date);
            const isPast = date < today;
            const isToday = date.toDateString() === today.toDateString();
            
            let classes = 'calendar-day';
            if (isToday) classes += ' today';
            if (isPast) classes += ' past';
            if (isBlocked) classes += ' blocked';
            
            html += `
                <div class="${classes}" onclick="selectDate('${date.toISOString()}')" ${isPast || isBlocked ? 'style="cursor: not-allowed;"' : ''}>
                    ${day}
                </div>
            `;
        }

        html += `</div>`;
        calendar.innerHTML = html;
    }

    // Check if date is blocked
    function isDateBlocked(date) {
        return blockedDates.some(blocked => 
            blocked.toDateString() === date.toDateString()
        );
    }

    // Change month
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // Select a date
    function selectDate(dateString) {
        const date = new Date(dateString);
        const today = new Date();
        today.setHours(0,0,0,0);
        
        if (date < today) {
            alert('Please select a future date.');
            return;
        }
        
        if (isDateBlocked(date)) {
            alert('This date is fully booked. Please select another date.');
            return;
        }
        
        selectedDate = date;
        document.getElementById('calendar').style.display = 'none';
        document.getElementById('timeSlotsPanel').style.display = 'block';
        document.getElementById('selectedDateDisplay').innerHTML = 
            `${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        
        fetchTimeSlots(date);
    }

    // Fetch available time slots
    function fetchTimeSlots(date) {
        const formattedDate = date.toISOString().split('T')[0];
        
        fetch(`/api/available-slots?date=${formattedDate}`)
            .then(response => response.json())
            .then(data => {
                const timeSlots = document.getElementById('timeSlots');
                if (data.slots.length === 0) {
                    timeSlots.innerHTML = '<p class="no-slots">No available slots for this date.</p>';
                    return;
                }
                
                timeSlots.innerHTML = data.slots.map(slot => `
                    <div class="time-slot" onclick="selectTimeSlot('${slot}')">
                        ${slot}
                    </div>
                `).join('');
            });
    }

    // Select a time slot
    function selectTimeSlot(time) {
        if (confirm(`Book appointment for ${selectedDate.toLocaleDateString()} at ${time}?`)) {
            window.location.href = `/booking?date=${selectedDate.toISOString().split('T')[0]}&time=${time}`;
        }
    }

    // Back to calendar
    function backToCalendar() {
        document.getElementById('calendar').style.display = 'block';
        document.getElementById('timeSlotsPanel').style.display = 'none';
        selectedDate = null;
    }

    // Initialize on page load
    initCalendar();
</script>
{% endblock %}